<!DOCTYPE html>
<html>

<head>
    <title>서머너즈워 중턴 계산기</title>
    <link rel="shortcut icon" href="favicon.ico">
    <style>
        header,
        p, .center {
            text-align: center;
        }
        .left{
            text-align: left;
        }

        button:hover {
            color: white;
            background-color: green;
        }

        button {
            font-size: 16px;
            display: inline-block;
            border: 1px solid green;
            padding: 6px 13px;
            margin: 8px 0px;
            color: green;
            background-color: white;
            text-decoration: none;
            transition: 0.2s;
            width: 100%;
        }

        .white_button {
            font-size: 16px;
            display: inline-block;
            border: 1px solid green;
            color: green;
            background-color: white;
            text-decoration: none;
            width: 100%;
        }

        .green_button {
            font-size: 16px;
            display: inline-block;
            border: 1px solid green;
            color: white;
            background-color: green;
            text-decoration: none;
            width: 100%;
        }

        .red {
            color: red;
            font-weight: bold;
        }

        .green {
            color: green;
            font-weight: bold;
        }

        table {
            width: 100%;
            border: 1px solid grey;
            border-radius: 5px;
        }

        tr:hover {
            background: #eee;
        }

        td {
            width: auto;
            max-width: 100px;
            text-align: center;
        }

        input[type="number"],input[type="text"] {
            width: 100%;
            max-width: 100px;
            font-size: 15px;
        }

        [class*="col-"] {
            float: left;
        }

        .col-1 {
            width: 8.33%;
        }

        .col-2 {
            width: 16.66%;
        }

        .col-3 {
            width: 25%;
        }

        .col-4 {
            width: 33.33%;
        }

        .col-5 {
            width: 41.66%;
        }

        .col-6 {
            width: 50%;
        }

        .col-7 {
            width: 58.33%;
        }

        .col-8 {
            width: 66.66%;
        }

        .col-9 {
            width: 75%;
        }

        .col-10 {
            width: 83.33%;
        }

        .col-11 {
            width: 91.66%;
        }

        .col-12 {
            width: 100%;
        }

        @media only screen and (max-width: 768px) {
            [class*="col-"] {
                width: 100%;
            }

            table {
                width: 100%;
            }
        }
    </style>
</head>

<body onkeydown="if(event.keyCode == 13){ calc();}">
    <header>
        <h1>서머너즈워 중턴 계산기</h1>
    </header>
    <section class="col-12">
        <table class="col-4" id='rapid_list'>
        </table>
        <table class="col-8">
            <tr>
                <td>계산할 틱 수 <input type="number" class="tic_count" value="10"/>회</td>
            </tr>
            <tr>
                <td>틱당 수치 <input type="number" class='tic' value='7' />%</td>
            </tr>
            <tr>
                <td><input id='show_tic_option' type='button' onclick="button_click(this, '턴 획득 틱만 보기', '모든 틱 보기');" class='white_button' value='모든 틱 보기' min='0'/></td>
            </tr>
            <tr>
                <td>공속 토템 <input type="number" class="totem" value='15' />%</td>
            </tr>
            <tr>
                <td>공속 리더 <input type="number" class="leader" />%</td>
            </tr>
            <tr id='enemy_first'>
                <td><input onclick="enemy_stat_active(this)" type='button' class='col-4 white_button' value='적 선턴 속도' min='0'/>
                       
                    <!-- getElementsByTag("span")으로 사용중 -->
                    <span style="display: none;"><input type='number' placeholder="기본속"/>+<input type='number' placeholder="뒷속"/>=<input type='number' placeholder='합 속' disabled/></span>
                <span>아군 선턴과 같게</span></td>
            </tr>
            <script>
                let enemy_first = document.getElementById("enemy_first");
                function enemy_stat_active(obj){
                    const str = "적 선턴 속도";
                    button_click(obj, str+" 커스텀", str);
                    let childs = enemy_first.getElementsByTagName('span');
                    let speed_input = childs[0];
                    let same = childs[1];
                    if(obj.min == '0'){
                        speed_input.style.display = 'none';
                        same.style.display = 'block';
                    }
                    else{
                        speed_input.style.display = 'block';
                        same.style.display = 'none';
                    }
                }
            </script>
            <table>
                
    </section>
    <br />
    <section class="col-12">
        <p>배치 순서대로 놓아주세요.</p>
        <div id='input_struct'>
        </div>
    </section>
    <button onclick="calc()">계산</button>
    <section class='col-12' id='output'>
    </section>
    <footer class="col-12">
        
        <a href="https://veev23.github.io/"><button>설명 페이지</button></a>
        마지막 수정일 : 2020-04-18<br />
        <br />
        <br />
    </footer>
</body>
<script>
    var max_tic;
    function getFloatVal(parent, id) {
        let tmp = getVal(parent, id);
        tmp = parseFloat(tmp);
        if (isNaN(tmp)) return 0;
        return tmp;
    }
    function inputParseInt(string){
        let tmp = parseInt(string);
        if(isNaN(tmp)) return 0;
        return tmp;
    }
    function getIntVal(parent, id) {
        let tmp = getVal(parent, id);
        return inputParseInt(tmp);
    }
    function getVal(parent, id) {
        let tmp = parent.getElementsByClassName(id)[0];
        if (tmp.type == "button") {
            return tmp.min == 1;
        }
        return tmp.value;
    }
    function setVal(parent, id, value) {
        let tmp = parent.getElementsByClassName(id)[0];
        tmp.innerHTML = value;
    }
    const max_member = 4;
    function button_click(obj, positive, negative) {
        if (obj.min == '1') {
            obj.value = negative;
            obj.min = 0;
        }
        else {
            obj.value = positive;
            obj.min = 1;
        }
        obj.classList.toggle("white_button");
        obj.classList.toggle("green_button");
    }
    function make_inputs() {
        let struct = document.getElementById("input_struct");
        let seperator = [["존재", "미존재"], ["착용", "미착용"]];
        for (let i = 1; i <= max_member; i++) {
            let input_tag =
                '<span class="monster_info col-3">' +
                '<table>' +
                '<tr><td>몹 이름</td><td><input type="text" class="mob_name" value="' + i + '번째 몹"/></td></tr>' +
                '<tr>' +
                '<td>기본 공속 : </td>' +
                '<td><input type="number" class="base" /></td>' +
                '</tr>' +
                '<tr>' +
                '<td>뒷 공속 : </td>' +
                '<td><input type="number" class="after" /></td>' +
                '</tr>' +
                '<tr>' +
                '<td>아군게이지업 : </td>' +
                '<td><input type="number" class="gauge" placeholder="증가량%"/></td>' +
                '</tr>' +
                '<tr>' +
                '<td>속업 버프 : </td>' +
                '<td><input type="button" class="is_speedUp white_button" value="' + seperator[0][1] + '" min="0"/></td>' +
                '</tr>' +
                '<tr>' +
                '<td>신속룬 착용 : </td>' +
                '<td><input type="button" class="is_swift white_button" value="' + seperator[1][1] + '" min="0"/></td>' +
                '</tr>' +
                '<tr>' +
                '<td>적게이지업(응보) : </td>' +
                '<td><input type="number" class="enemy_gauge" placeholder="공격 후"/></td>' +
                '</tr>' +
                '<tr>' +
                '<td>합 속도 :</td>' +
                '<td class="sum"></td>' +
                '</tr>' +
                '</table>' +
                '</span>';
            struct.innerHTML += input_tag;
        }
        let info = document.getElementsByClassName("monster_info");
        for (let i = 0; i < max_member; i++) {
            let speedUp = info[i].getElementsByClassName("is_speedUp")[0];
            speedUp.addEventListener("click", function () { button_click(speedUp, seperator[0][0], seperator[0][1]) });
            let swift = info[i].getElementsByClassName("is_swift")[0];
            swift.addEventListener("click", function () { button_click(swift, seperator[1][0], seperator[1][1]) });
        }
    }
    function predict_speed(base, sum_speed) {
        if(sum_speed == undefined) return 0;
        let swift = base * 0.25;
        let rune = Math.floor(sum_speed - (base * (100 + totem + leader) / 100 + swift));
        let after = Math.ceil(rune + swift);
        return after;
    }
    function get_speed_by(info){
        let base = getFloatVal(info, 'base');
        let after = getFloatVal(info, 'after');
        let is_swift = getVal(info, 'is_swift');
        let ret = get_speed(base, after, is_swift);
        setVal(info, 'sum', ret);
        return ret;
    }
    function get_speed(base, after, is_swift) {
        let swift;
        if (is_swift) {
            swift = base * 0.25;
        }
        else {
            swift = 0;
        }
        let rune = Math.floor(after - swift);
        let ret = base * (100 + totem + leader) / 100 + swift + rune;
        ret = Math.ceil(ret);
        return ret;
    }
    // 0~length-1까지 val을 더함
    function add_to_array_eles(array, length, val) {
        for (let i = 0; i < length; i++) {
            array[i] += val;
        }
    }
    function get_max(array, length) {
        let ret = array[0];
        for (let i = 1; i < length; i++) {
            ret = Math.max(ret, array[i]);
        }
        return ret;
    }
    //다른 선턴잡이들 경우는 뒷속 몇?
    function calc_rapid_list(sum_speed) {
        let table = document.getElementById("rapid_list")
        table.innerHTML ="<caption>적 선턴잡이들 뒷속은?(신속기준)</caption><tr><th>몹이름</th><th>기본속</th><th>뒷속</th></tr>";
        const rapid = [
            ["풍극지", 96],
            ["물브라", 106],
            ["암해적", 108],
            ["풍그리폰", 111],
            ["풍해왕", 116],
            ["암선인", 118],
            ["빛하피", 120]];
        for (const e of rapid) {
            let tr = document.createElement("tr");
            let td = document.createElement("td");
            td.innerHTML = e[0];
            tr.appendChild(td);
            td = document.createElement("td");
            td.innerHTML = e[1];
            tr.appendChild(td);
            td = document.createElement("td");
            let res = predict_speed(e[1], sum_speed);
            td.innerHTML = res;
            tr.appendChild(td);
            table.appendChild(tr);
        }
    }
    const scale = 1000;
    function calc_tics(info) {
        let is_speedUp = false;
        let tic_per = scale * getFloatVal(document, 'tic') / 100;
        let speeds = [];
        let gauge_ups = [];
        let enemy_gauge_ups = [];
        let whos_turn = [];
        
        gauge_ups[max_member] = 0;
        enemy_gauge_ups[max_member] = 0;

        for (let i = 0; i < max_member; i++) {
            speeds[i] = get_speed_by(info[i]);
            gauge_ups[i] = getFloatVal(info[i], 'gauge') * scale;
            enemy_gauge_ups[i] = getFloatVal(info[i], 'enemy_gauge') * scale;
        }
        //적 공격속도 세팅
        if(enemy_first.getElementsByTagName('input')[0].min =='0'){
        speeds[max_member] = get_max(speeds, max_member);
        }
        else{
            let enemy_inputs = enemy_first.getElementsByTagName("span")[0].getElementsByTagName('input');
            let e_base = inputParseInt(enemy_inputs[0].value);
            let e_after = inputParseInt(enemy_inputs[1].value);
            //적 공격속도 커스텀인 경우 신속룬 영향 x라고 가정
            speeds[max_member] = get_speed(e_base, e_after, false);
            enemy_inputs[2].value = speeds[max_member];
        }
        calc_rapid_list(speeds[max_member]);

        //now_gauge[tic][n]=gauge
        let now_gauge = [[0, 0, 0, 0, 0]];
        for (let i = 1; i <= max_tic; i++) {
            let max = 0, m_idx = 0;
            now_gauge[i] = [];
            //게이지 갱신
            for (let m = 0; m <= max_member; m++) {
                now_gauge[i][m] = now_gauge[i - 1][m]
            }
            //게이지 업 했는지?
            if (whos_turn[i - 1] != undefined) {
                now_gauge[i][whos_turn[i - 1]] = 0;
                //아군 게이지 업
                add_to_array_eles(now_gauge[i], max_member, gauge_ups[whos_turn[i - 1]]);
                gauge_ups[whos_turn[i - 1]] = 0;
                //적군 게이지 업
                now_gauge[i][max_member] += enemy_gauge_ups[whos_turn[i-1]];
                enemy_gauge_ups[whos_turn[i-1]] = 0;
            }
            //자연게이지
            for (let m = 0; m < max_member; m++) {
                //TODO : 속업에 대해서도 고려해야함
                now_gauge[i][m] += (is_speedUp ? Math.ceil(speeds[m] * 1.3) : speeds[m]) * tic_per;
            }
            //적은 속업 감안 x
            now_gauge[i][max_member] += speeds[max_member] * tic_per;

            //게이지 가장 높은 애 탐색
            for (let member = 0; member <= max_member; member++) {
                if (now_gauge[i][member] > max) {
                    max = now_gauge[i][member];
                    m_idx = member;
                }
            }
            if (max >= 100*scale) {
                //m_idx가 턴잡음
                whos_turn[i] = m_idx;
                if (m_idx != max_member && getVal(info[m_idx], 'is_speedUp')) {
                    is_speedUp = true;
                }
            }
        }
        return [now_gauge, whos_turn];
    }
    function print_tics(now_gauge, whos_turn, mob_name) {
        let show_tic_option = inputParseInt(document.getElementById('show_tic_option').min);
        const ALL = 0;
        
        let output_div = document.getElementById('output');
        let output = '<table><tr><td></td>';
        for (let i = 0; i <= max_member; i++) {
            output += '<td>' + mob_name[i] + '</td>';
        }
        output += '</tr>';
        for (let i = 1; i <= max_tic; i++) {
            if(show_tic_option != ALL && whos_turn[i] == undefined) continue;
            output += '<tr><td>' + i + '틱</td>';
            for (let m = 0; m <= max_member; m++) {
                output += '<td' + ((whos_turn[i] == m) ? ' class="red"' : '') + '>' + (now_gauge[i][m]/scale).toFixed(2) + '</td>';
            }
            output += '</tr>';
        }
        output += "</table><p>";
        for (let i = 1; i <= max_tic; i++) {
            if (whos_turn[i] == undefined) continue;
            let t = whos_turn[i]
            output += '<span class="' + (t == max_member ? 'green' : 'red') + '">' + mob_name[t] + '</span>->';
        }
        output += "순으로 이어받습니다.</p>";
        output_div.innerHTML = output;
    }
    let totem = NaN;
    let leader = NaN;
    function calc() {
        max_tic = getIntVal(document, 'tic_count');
        if(max_tic > 300 && !confirm("리스트가 길어요.")){
            return;
        }
        totem = getFloatVal(document, 'totem');
        leader = getFloatVal(document, 'leader');
        let mob_name = [];
        let info = document.getElementsByClassName("monster_info");
        for (let i = 0; i < max_member; i++) {
            mob_name[i] = getVal(info[i], 'mob_name');
        }
        mob_name[max_member] = "적 선턴잡이";
        result_pair = calc_tics(info);
        print_tics(result_pair[0], result_pair[1], mob_name);
    }
</script>
<script>
    function main() {
        make_inputs();
        calc_rapid_list();
    }
    main();
</script>

</html>
